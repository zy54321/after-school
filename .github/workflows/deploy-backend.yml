name: Deploy Backend to Tencent Cloud

# è§¦å‘è§„åˆ™ï¼šåªæœ‰å½“ push åˆ° main åˆ†æ”¯ï¼Œä¸”ä¿®æ”¹äº† server ç›®å½•ä¸‹çš„æ–‡ä»¶æ—¶æ‰è§¦å‘
on:
  push:
    branches: [ "main" ]
    paths:
      - "server/**"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšš Checkout code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # ğŸ’¡ æ ¸å¿ƒæŒ‡ä»¤ï¼šæœºå™¨äººè¿ä¸ŠæœåŠ¡å™¨åè¦å¹²çš„äº‹
          script: |
            echo "1. è¿›å…¥é¡¹ç›®æ ¹ç›®å½•..."
            cd /var/www/after-school

            echo "2. æ‹‰å–æœ€æ–°ä»£ç ..."
            # å¦‚æœæœ¬åœ°æœ‰ä¿®æ”¹å†²çªï¼Œè¿™ä¸€æ­¥å¯èƒ½ä¼šå¤±è´¥ï¼Œå»ºè®®ä¿æŒæœåŠ¡å™¨ä»£ç å¹²å‡€
            git pull origin main

            echo "3. è¿›å…¥åç«¯ç›®å½•å¹¶å®‰è£…ä¾èµ–..."
            cd server
            # ä»…å½“ package.json å˜åŠ¨æ—¶æ‰éœ€è¦ installï¼Œä½†å¤šè·‘ä¸€æ¬¡ä¹Ÿæ— å¦¨
            npm install --production

            echo "4. é‡å¯ PM2 æœåŠ¡..."
            pm2 restart server
            
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"