# API æ¥å£å‚è€ƒæ–‡æ¡£

## ğŸ“‹ æ¥å£æ¦‚è§ˆ

æ‰€æœ‰ API æ¥å£å‡ä»¥ `/api` ä¸ºå‰ç¼€ï¼Œéœ€è¦ç™»å½•çš„æ¥å£ä¼šè¿”å› 401 çŠ¶æ€ç ï¼ˆæœªç™»å½•ï¼‰æˆ– 403 çŠ¶æ€ç ï¼ˆæƒé™ä¸è¶³ï¼‰ã€‚

---

## ğŸ” è®¤è¯ç›¸å…³

### POST /api/login
ç”¨æˆ·ç™»å½•

**è¯·æ±‚ä½“ï¼š**
```json
{
  "username": "admin",
  "password": "123456"
}
```

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "username": "admin",
    "real_name": "ç®¡ç†å‘˜",
    "role": "admin"
  }
}
```

---

## ğŸ‘¥ å­¦å‘˜ç®¡ç†

### GET /api/students
è·å–å­¦å‘˜åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°ï¼š**
- `page` (å¯é€‰): é¡µç ï¼Œé»˜è®¤ 1
- `pageSize` (å¯é€‰): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ 10
- `keyword` (å¯é€‰): æœç´¢å…³é”®è¯ï¼ˆå§“åã€ç”µè¯ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "list": [...],
    "total": 100
  }
}
```

### GET /api/students/:id
è·å–å­¦å‘˜è¯¦æƒ…

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "id": 1,
    "name": "å¼ ä¸‰",
    "phone": "13800138000",
    "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",
    "longitude": 116.397,
    "latitude": 39.918,
    "courses": [...]
  }
}
```

### POST /api/students
åˆ›å»ºå­¦å‘˜

**è¯·æ±‚ä½“ï¼š**
```json
{
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",
  "longitude": 116.397,
  "latitude": 39.918
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

### PUT /api/students/:id
æ›´æ–°å­¦å‘˜ä¿¡æ¯

**è¯·æ±‚ä½“ï¼š**
```json
{
  "name": "å¼ ä¸‰",
  "phone": "13800138000",
  "address": "åŒ—äº¬å¸‚æœé˜³åŒº...",
  "longitude": 116.397,
  "latitude": 39.918
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

### DELETE /api/students/:id
åˆ é™¤å­¦å‘˜ï¼ˆè½¯åˆ é™¤ï¼‰

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

### GET /api/students/locations
è·å–å­¦å‘˜ä½ç½®æ•°æ®ï¼ˆGeoJSONæ ¼å¼ï¼‰

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "type": "FeatureCollection",
    "features": [...]
  }
}
```

### GET /api/students/nearby
é™„è¿‘å­¦å‘˜æœç´¢

**æŸ¥è¯¢å‚æ•°ï¼š**
- `lng`: ç»åº¦
- `lat`: çº¬åº¦
- `radius` (å¯é€‰): æœç´¢åŠå¾„ï¼ˆç±³ï¼‰ï¼Œé»˜è®¤ 5000

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": [...]
}
```

### POST /api/students/:id/drop
åŠç†é€€è¯¾/é€€è´¹

**è¯·æ±‚ä½“ï¼š**
```json
{
  "class_id": 1,
  "refund_amount": 1000
}
```

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

---

## ğŸ“š è¯¾ç¨‹/ç­çº§ç®¡ç†

### GET /api/classes
è·å–è¯¾ç¨‹åˆ—è¡¨

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": [...]
}
```

### POST /api/classes
åˆ›å»ºè¯¾ç¨‹

**è¯·æ±‚ä½“ï¼š**
```json
{
  "name": "æ•°å­¦åŸºç¡€ç­",
  "teacher_id": 1,
  "billing_type": "time",
  "class_start_date": "2024-01-01",
  "schedule_days": [1, 3, 5],
  "time_range": "18:00-20:00",
  "description": "è¯¾ç¨‹æè¿°"
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

### PUT /api/classes/:id
æ›´æ–°è¯¾ç¨‹ä¿¡æ¯

**æƒé™ï¼š** éœ€è¦ç™»å½•

### DELETE /api/classes/:id
åˆ é™¤è¯¾ç¨‹ï¼ˆç¡¬åˆ é™¤ï¼Œéœ€æ£€æŸ¥ä¾èµ–ï¼‰

**æƒé™ï¼š** éœ€è¦ç™»å½•

**é”™è¯¯å“åº”ï¼ˆå­˜åœ¨ä¾èµ–ï¼‰ï¼š**
```json
{
  "code": 400,
  "msg": "è¯¥è¯¾ç¨‹å­˜åœ¨å…³è”æ•°æ®ï¼Œæ— æ³•åˆ é™¤ã€‚å»ºè®®ä½¿ç”¨åœç”¨åŠŸèƒ½ã€‚"
}
```

---

## ğŸ’° è®¢å•ç®¡ç†

### GET /api/orders
è·å–è®¢å•åˆ—è¡¨

**æŸ¥è¯¢å‚æ•°ï¼š**
- `student_id` (å¯é€‰): å­¦å‘˜ID
- `class_id` (å¯é€‰): è¯¾ç¨‹ID
- `page` (å¯é€‰): é¡µç 
- `pageSize` (å¯é€‰): æ¯é¡µæ•°é‡

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "list": [...],
    "total": 50
  }
}
```

### POST /api/orders
åˆ›å»ºè®¢å•ï¼ˆæŠ¥å/ç»­è´¹ï¼‰

**è¯·æ±‚ä½“ï¼š**
```json
{
  "student_id": 1,
  "class_id": 1,
  "quantity": 10,
  "amount": 2000,
  "payment_method": "cash"
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

---

## âœ… ç­¾åˆ°ç®¡ç†

### POST /api/attendance/checkin
å­¦å‘˜ç­¾åˆ°

**è¯·æ±‚ä½“ï¼š**
```json
{
  "student_id": 1,
  "class_id": 1
}
```

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "message": "ç­¾åˆ°æˆåŠŸ",
    "expired_at": "2024-12-31"
  }
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

---

## ğŸ“Š ä»ªè¡¨ç›˜

### GET /api/dashboard
è·å–ä»ªè¡¨ç›˜ç»Ÿè®¡æ•°æ®

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "totalStudents": 100,
    "totalClasses": 10,
    "todayCheckins": 5,
    "lowBalanceCount": 3,
    "lowBalanceList": [...]
  }
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

---

## ğŸ‘¤ ç”¨æˆ·ç®¡ç†

### GET /api/users
è·å–ç”¨æˆ·åˆ—è¡¨

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

### POST /api/users
åˆ›å»ºç”¨æˆ·

**è¯·æ±‚ä½“ï¼š**
```json
{
  "username": "teacher1",
  "password": "123456",
  "real_name": "æ•™å¸ˆ1",
  "role": "teacher"
}
```

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

### PUT /api/users/:id
æ›´æ–°ç”¨æˆ·ä¿¡æ¯

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

### PUT /api/users/:id/reset-password
é‡ç½®ç”¨æˆ·å¯†ç 

**è¯·æ±‚ä½“ï¼š**
```json
{
  "new_password": "newpassword123"
}
```

**æƒé™ï¼š** éœ€è¦ç®¡ç†å‘˜æƒé™

---

## ğŸ—ºï¸ å•†ä¸šåˆ†æï¼ˆMapboxï¼‰

### GET /api/mapbox/places
åœ°ç‚¹æœç´¢ï¼ˆGeocodingï¼‰

**æŸ¥è¯¢å‚æ•°ï¼š**
- `q`: æœç´¢å…³é”®è¯

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "features": [...]
  }
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

### GET /api/mapbox/features
è·å–æ‰€æœ‰åœ°å›¾è¦ç´ 

**å“åº”ï¼š**
```json
{
  "code": 200,
  "data": {
    "type": "FeatureCollection",
    "features": [...]
  }
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•

### POST /api/mapbox/features
åˆ›å»ºåœ°å›¾è¦ç´ 

**è¯·æ±‚ä½“ï¼š**
```json
{
  "name": "ç«äº‰å¯¹æ‰‹A",
  "feature_type": "Point",
  "category": "competitor",
  "properties": {
    "price": 5000,
    "students": 100
  },
  "geometry": {
    "type": "Point",
    "coordinates": [116.397, 39.918]
  }
}
```

**æƒé™ï¼š** éœ€è¦ç™»å½•ï¼ˆç®¡ç†å‘˜å¯ç¼–è¾‘ï¼‰

### DELETE /api/mapbox/features/:id
åˆ é™¤åœ°å›¾è¦ç´ 

**æƒé™ï¼š** éœ€è¦ç™»å½•ï¼ˆç®¡ç†å‘˜å¯åˆ é™¤ï¼‰

---

## ğŸ—ºï¸ é«˜å¾·åœ°å›¾ï¼ˆå·²åºŸå¼ƒï¼‰

### GET /api/amap/tips
åœ°ç‚¹æœç´¢æç¤º

**æ³¨æ„ï¼š** æ­¤æ¥å£å·²åºŸå¼ƒï¼Œå»ºè®®ä½¿ç”¨ Mapbox æ¥å£ã€‚

---

## ğŸ“ é€šç”¨å“åº”æ ¼å¼

### æˆåŠŸå“åº”
```json
{
  "code": 200,
  "data": {...}
}
```

### é”™è¯¯å“åº”
```json
{
  "code": 400,  // æˆ– 401, 403, 500
  "msg": "é”™è¯¯ä¿¡æ¯"
}
```

### HTTP çŠ¶æ€ç 
- `200`: æˆåŠŸ
- `400`: è¯·æ±‚é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ã€ä¸šåŠ¡é€»è¾‘é”™è¯¯ï¼‰
- `401`: æœªç™»å½•
- `403`: æƒé™ä¸è¶³
- `500`: æœåŠ¡å™¨é”™è¯¯

---

## ğŸ”’ æƒé™è¯´æ˜

### è§’è‰²ç±»å‹
- `admin`: ç®¡ç†å‘˜ - æ‹¥æœ‰æ‰€æœ‰æƒé™
- `teacher`: æ™®é€šæ•™å¸ˆ - åŸºç¡€æƒé™
- `visitor`: æ¸¸å®¢ - ä»…å¯æŸ¥çœ‹

### æƒé™è§„åˆ™
1. **éœ€è¦ç™»å½•çš„æ¥å£**ï¼šæ‰€æœ‰ `/api/*` æ¥å£ï¼ˆé™¤ `/api/login`ï¼‰éƒ½éœ€è¦ç™»å½•
2. **éœ€è¦ç®¡ç†å‘˜æƒé™çš„æ¥å£**ï¼š
   - `DELETE /api/students/:id`
   - `POST /api/students/:id/drop`
   - æ‰€æœ‰ `/api/users/*` æ¥å£
3. **æ¸¸å®¢æƒé™é™åˆ¶**ï¼š
   - å•†ä¸šåˆ†æåœ°å›¾ï¼šæ¸¸å®¢ä»…å¯æŸ¥çœ‹ï¼Œæ— æ³•æ·»åŠ /åˆ é™¤æ•°æ®

---

## ğŸ“Œ æ³¨æ„äº‹é¡¹

1. **è®¤è¯æ–¹å¼**ï¼šä½¿ç”¨ Session è®¤è¯ï¼Œç™»å½•åä¼šåœ¨ Cookie ä¸­è®¾ç½® session
2. **CORS**ï¼šå·²é…ç½®è·¨åŸŸï¼Œæ”¯æŒå¤šä¸ªå‰ç«¯åŸŸå
3. **æ•°æ®åº“**ï¼šä½¿ç”¨ PostgreSQL + PostGISï¼ˆç©ºé—´æ•°æ®æ”¯æŒï¼‰
4. **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€ä½¿ç”¨ `code` å’Œ `msg` å­—æ®µè¿”å›é”™è¯¯ä¿¡æ¯

