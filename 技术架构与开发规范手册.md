# ğŸ“˜ æ‰˜ç®¡ç­ç®¡ç†ç³»ç»Ÿ - æŠ€æœ¯æ¶æ„ä¸å¼€å‘è§„èŒƒæ‰‹å†Œ

## 1. ç³»ç»Ÿæ¶æ„æ¦‚è¿° (System Architecture)

æœ¬é¡¹ç›®é‡‡ç”¨ **â€œå¤šå­ç³»ç»Ÿæ¨¡å—åŒ–â€** æ¶æ„ã€‚ä¸ºäº†ä¿æŒä»£ç æ¸…æ™°ï¼Œæˆ‘ä»¬ä¸æŒ‰æŠ€æœ¯å±‚ï¼ˆController/Model/Viewï¼‰åˆ†æ–‡ä»¶å¤¹ï¼Œè€Œæ˜¯æŒ‰**ä¸šåŠ¡é¢†åŸŸï¼ˆDomainï¼‰**åˆ†æ–‡ä»¶å¤¹ã€‚

### 1.1 ç›®å½•ç»“æ„æ ‡å‡†

æ‰€æœ‰ä¸šåŠ¡åŠŸèƒ½å¿…é¡»å½’ç±»åˆ° `systems` ç›®å½•ä¸‹å¯¹åº”çš„å­ç³»ç»Ÿä¸­ã€‚

```
/server/src/systems/
  â”œâ”€â”€ education/     # æ•™åŠ¡ç³»ç»Ÿ (æ ¸å¿ƒä¸šåŠ¡: å­¦ç”Ÿ, ç­çº§, è€ƒå‹¤)
  â”œâ”€â”€ analytics/     # å•†ä¸šåˆ†æ (Mapbox, æ•°æ®å¯è§†åŒ–)
  â”œâ”€â”€ family/        # å®¶åº­æˆé•¿ (ç§¯åˆ†, ä»»åŠ¡)
  â””â”€â”€ [new_system]/  # æ–°å¢ç³»ç»Ÿè¯·åœ¨æ­¤æ–°å»ºæ–‡ä»¶å¤¹
       â”œâ”€â”€ controllers/
       â”œâ”€â”€ routes/
       â””â”€â”€ services/ (å¯é€‰)

/client/src/systems/
  â”œâ”€â”€ education/
  â”œâ”€â”€ analytics/
  â”œâ”€â”€ family/
  â””â”€â”€ [new_system]/
       â”œâ”€â”€ views/       # é¡µé¢çº§ç»„ä»¶
       â”œâ”€â”€ components/  # ä¸šåŠ¡é€šç”¨ç»„ä»¶
       â””â”€â”€ router.js    # (å¯é€‰) æ¨¡å—è·¯ç”±é…ç½®

```

---

## 2. åç«¯å¼€å‘è§„èŒƒ (Node.js/Express)

### 2.1 é‰´æƒä¸ç”¨æˆ·ä¿¡æ¯è·å– (âš ï¸ æ ¸å¿ƒè§„èŒƒ)

æœ¬é¡¹ç›®ä½¿ç”¨ `express-session` + `connect-pg-simple` è¿›è¡Œä¼šè¯ç®¡ç†ã€‚

* **åŸåˆ™**ï¼šä¸­é—´ä»¶ `authMiddleware.js` **ä¸**æŒ‚è½½ `req.user`ï¼Œä»…æ£€æŸ¥ `req.session.user`ã€‚
* **è·å–ç”¨æˆ· ID**ï¼šåœ¨ Controller ä¸­ï¼Œ**ä¸¥ç¦**ä½¿ç”¨ `req.user.id`ã€‚
* âœ… **æ­£ç¡®å†™æ³•**ï¼š`const userId = req.session.user.id;`
* âŒ **é”™è¯¯å†™æ³•**ï¼š`const userId = req.user.id;` (ä¼šå¯¼è‡´ undefined æŠ¥é”™)



### 2.2 è·¯ç”±æ³¨å†Œ (Route Registration)

æ–°å¢ä¸€ä¸ªä¸šåŠ¡æ¨¡å—åï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹ä¸‰æ­¥ï¼š

1. **å®šä¹‰è·¯ç”±æ–‡ä»¶**ï¼šåœ¨ `server/src/systems/[module]/routes/` ä¸‹åˆ›å»ºè·¯ç”±æ–‡ä»¶ã€‚
2. **å¼•å…¥å…¥å£æ–‡ä»¶**ï¼šåœ¨ `server/app.js` å¤´éƒ¨ `require` è¯¥è·¯ç”±æ–‡ä»¶ã€‚
3. **æ³¨å†Œå¹¶åŠ é”**ï¼šåœ¨ `server/app.js` çš„ `// æŒ‚è½½è·¯ç”±` åŒºåŸŸæ³¨å†Œï¼Œå¹¶**åŠ¡å¿…**åŠ ä¸Š `checkAuth` ä¸­é—´ä»¶ã€‚

```javascript
// server/app.js ç¤ºä¾‹
const familyRoutes = require('./src/systems/family/routes/familyRoutes');
// ...
// âœ… å¿…é¡»åŠ  checkAuth
app.use('/api/family', checkAuth, familyRoutes);

```

### 2.3 æ•°æ®åº“äº¤äº’ (Database Interaction)

* **è¿æ¥æ± **ï¼šç»Ÿä¸€ä½¿ç”¨ `require('../../../shared/config/db')` å¯¼å…¥ `pool`ã€‚
* **äº‹åŠ¡å¤„ç†**ï¼šæ¶‰åŠèµ„é‡‘ã€ç§¯åˆ†æ‰£å‡ç­‰å…³é”®æ“ä½œï¼Œ**å¿…é¡»**ä½¿ç”¨ `BEGIN ... COMMIT/ROLLBACK` äº‹åŠ¡ã€‚
* **SQL è§„èŒƒ**ï¼š
* è¡¨å/å­—æ®µåä½¿ç”¨ **snake_case** (å¦‚ `family_points_log`, `is_active`)ã€‚
* ç¦æ­¢ä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥ SQLï¼Œå¿…é¡»ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ `$1, $2` é˜²æ­¢æ³¨å…¥ã€‚



### 2.4 æ¥å£å“åº”æ ¼å¼ (Response Standard)

æ‰€æœ‰æ¥å£å¿…é¡»è¿”å›ç»Ÿä¸€çš„ JSON ç»“æ„ï¼š

```javascript
// æˆåŠŸ
res.json({
  code: 200,
  msg: 'æ“ä½œæˆåŠŸ',
  data: { ... }
});

// å¤±è´¥
res.status(500).json({
  code: 500, // æˆ– 400, 401, 403
  msg: 'é”™è¯¯æè¿°'
});

```

---

## 3. å‰ç«¯å¼€å‘è§„èŒƒ (Vue 3 + Vite)

### 3.1 ç»„ä»¶é£æ ¼

* ç»Ÿä¸€ä½¿ç”¨ Vue 3 **Composition API** (`<script setup>`)ã€‚
* UI åº“ç»Ÿä¸€ä½¿ç”¨ **Element Plus**ã€‚
* æ ·å¼ä¼˜å…ˆä½¿ç”¨ **Scoped CSS** æˆ– **Tailwind CSS** ç±»åã€‚

### 3.2 é¡µé¢å¸ƒå±€ (Layout)

* **é—¨æˆ·é¡µ**ï¼šæ‰€æœ‰ç³»ç»Ÿçš„å…¥å£åœ¨ `client/src/portal/views/Home.vue`ã€‚
* **ç³»ç»Ÿå†…é¡µ**ï¼š
* æ–°å­ç³»ç»Ÿå¦‚æœéœ€è¦ä¾§è¾¹æ å¯¼èˆªï¼Œè¯·å‚è€ƒå’Œæ–°å»º Layoutï¼ˆå¦‚ `EducationLayout.vue`ï¼‰ã€‚
* å¦‚æœéœ€è¦å…¨å±æ²‰æµ¸å¼ä½“éªŒï¼ˆå¦‚å®¶åº­ç‰ˆ Dashboardï¼‰ï¼Œéœ€åœ¨ CSS ä¸­è®¾ç½® `height: 100vh; overflow: hidden;` å¹¶åœ¨å†…éƒ¨åŒºåŸŸå¤„ç†æ»šåŠ¨ã€‚



### 3.3 è·¯ç”±é…ç½®

* åœ¨ `client/src/router/index.js` ä¸­æ³¨å†Œè·¯ç”±ã€‚
* **é‰´æƒä¿æŠ¤**ï¼šæ‰€æœ‰å†…éƒ¨é¡µé¢è·¯ç”±å¿…é¡»æ·»åŠ  `meta: { requiresAuth: true }`ã€‚

```javascript
{
  path: '/family/dashboard',
  component: () => import('../systems/family/views/Dashboard.vue'),
  meta: { requiresAuth: true } // è·¯ç”±å®ˆå«ä¼šæ£€æŸ¥æ­¤æ ‡è®°
}

```

---

## 4. æ–°åŠŸèƒ½æ·»åŠ æµç¨‹ (Checklist)

å¦‚æœæ‚¨éœ€è¦å¼€å‘ä¸€ä¸ªæ–°çš„åŠŸèƒ½æ¨¡å—ï¼ˆä¾‹å¦‚ï¼š**å›¾ä¹¦å€Ÿé˜…ç³»ç»Ÿ**ï¼‰ï¼Œè¯·æŒ‰ä»¥ä¸‹é¡ºåºæ‰§è¡Œï¼š

1. **æ•°æ®åº“è®¾è®¡**ï¼šç¼–å†™ SQL å»ºè¡¨è¯­å¥ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œã€‚
2. **åç«¯å¼€å‘**ï¼š
* åˆ›å»º `server/src/systems/library/controllers/bookController.js` (æ³¨æ„ `req.session.user`)ã€‚
* åˆ›å»º `server/src/systems/library/routes/bookRoutes.js`ã€‚
* **å…³é”®**ï¼šåœ¨ `server/app.js` ä¸­æ³¨å†Œ `/api/library` è·¯ç”±ã€‚


3. **å‰ç«¯å¼€å‘**ï¼š
* åˆ›å»º `client/src/systems/library/views/BookList.vue`ã€‚
* åœ¨ `client/src/router/index.js` æ·»åŠ è·¯ç”±ã€‚
* åœ¨ `client/src/portal/views/Home.vue` æ·»åŠ å¡ç‰‡å…¥å£ã€‚


4. **æµ‹è¯•**ï¼šé‡å¯å‰åç«¯æœåŠ¡ï¼Œæ£€æŸ¥æ§åˆ¶å°æ— æŠ¥é”™ã€‚

---

**å»ºè®®æ‚¨ä¿å­˜è¿™ä»½æ–‡æ¡£åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼ˆä¾‹å¦‚å‘½åä¸º `DEV_GUIDE.md`ï¼‰ï¼Œæ–¹ä¾¿æ—¥åæŸ¥é˜…ï¼**