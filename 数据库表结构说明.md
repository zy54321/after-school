# 数据库表结构说明文档

> 本文档详细说明托管班管理系统中三个核心子系统使用的数据库表及其关系

---

## 📋 目录

1. [教务管理系统](#1-教务管理系统-education-system)
2. [商业分析地图](#2-商业分析地图-catering-business-analysis)
3. [家庭成长银行](#3-家庭成长银行-family-points-system)
4. [表关系总结](#表关系总结)

---

## 1. 教务管理系统 (Education System)

教务管理系统负责学员管理、课程管理、签到消课、财务流水等核心业务。

### 1.1 核心业务表

#### `students` - 学员表
**用途**：存储学员基本信息、家长信息、地理位置坐标等

**主要字段**：
- `id` - 主键
- `name` - 学员姓名
- `gender` - 性别
- `grade` - 年级
- `parent_name` - 家长姓名
- `parent_phone` - 家长电话
- `balance` - 余额（分）
- `address` - 地址
- `longitude` / `latitude` - 地理坐标（GIS）
- `allergies` - 过敏信息
- `authorized_pickups` - 授权接送人
- `habit_goals` - 习惯目标（数组）
- `agreements_signed` - 协议签署状态
- `status` - 状态（'active' / 'inactive'）
- `joined_at` - 加入时间

**使用场景**：
- 学员列表展示
- 学员详情查看
- 地理位置分布（热力图）
- 周边生源搜索

---

#### `classes` - 课程/班级表
**用途**：定义课程商品，包含计费模式、学费单价、排课周期等

**主要字段**：
- `id` - 主键
- `class_name` - 课程名称
- `tuition_fee` - 学费（分）
- `billing_type` - 计费模式（'count' 按次 / 'time' 按期）
- `teacher_name` - 教师姓名
- `description` - 课程描述
- `start_date` / `end_date` - 课程起止日期
- `schedule_days` - 排课周期（如 "1,3,5" 表示周一三五）
- `time_range` - 时间段
- `duration_value` - 时长
- `is_active` - 是否激活

**使用场景**：
- 课程管理
- 报名时选择课程
- 计算课程有效期

---

#### `student_course_balance` - 学员课程余额表
**用途**：**核心关联表**，记录每个学员在每个班级的剩余课时或有效期

**主要字段**：
- `student_id` - 学员ID（外键）
- `class_id` - 课程ID（外键）
- `remaining_lessons` - 剩余课时（按次模式）
- `expired_at` - 有效期（按期模式）
- `created_at` / `updated_at` - 创建/更新时间

**使用场景**：
- 学员列表显示课程余额
- 签到前检查课程有效性
- 退课时清零余额

**业务逻辑**：
- 按次模式：使用 `remaining_lessons` 字段
- 按期模式：使用 `expired_at` 字段
- 两种模式都统一检查 `expired_at` 是否过期

---

#### `attendance` - 签到记录表
**用途**：记录消课流水，关联学员、班级和操作员

**主要字段**：
- `id` - 主键
- `student_id` - 学员ID（外键）
- `class_id` - 课程ID（外键）
- `operator_id` - 操作员ID（外键 → users）
- `sign_in_time` - 签到时间
- `status` - 状态（'present' 出席）

**使用场景**：
- 签到消课
- 签到历史查询
- 今日签到统计
- 防止重复签到（同一天同一课程）

---

#### `orders` - 订单流水表
**用途**：记录所有资金变动（充值、续费、退费）

**主要字段**：
- `id` - 主键
- `student_id` - 学员ID（外键）
- `class_id` - 课程ID（外键）
- `amount` - 金额（分，可为负数表示退费）
- `quantity` - 数量（课时数或月数）
- `remark` - 备注
- `fee_type` - 费用类型（'tuition' 学费等）
- `created_at` - 创建时间

**使用场景**：
- 财务流水记录
- 财务报表生成
- 退费时生成负数订单

**业务逻辑**：
- 退费时 `amount` 为负数，保证财务统计（`SUM(amount)`）准确

---

### 1.2 辅助表

#### `users` - 员工表
**用途**：存储账号、加密密码、角色、激活状态

**主要字段**：
- `id` - 主键
- `username` - 用户名
- `password` - 加密密码（bcrypt）
- `real_name` - 真实姓名
- `role` - 角色（'admin' / 'teacher'）
- `is_active` - 是否激活

**使用场景**：
- 用户登录认证
- 权限控制
- 签到操作员记录

---

#### `daily_reports` - 日报表
**用途**：记录学员每日表现数据

**主要字段**：
- `id` - 主键
- `student_id` - 学员ID（外键）
- `report_date` - 报告日期
- `focus_minutes` - 专注时长（分钟）
- `distraction_count` - 走神次数
- `meal_status` - 用餐状态
- `homework_rating` - 作业评级（A/B/C）
- `homework_tags` - 作业标签（数组）
- `discipline_rating` - 纪律评级
- `habit_rating` - 习惯评级
- `teacher_comment` - 教师评语
- `token` - 分享链接凭证

**使用场景**：
- 特训工作台日报录入
- 家长查看日报（通过 token）
- 商业分析统计实际人数

---

#### `daily_menus` - 每日菜单表
**用途**：记录每日实际菜单内容和照片

**主要字段**：
- `id` - 主键
- `report_date` - 报告日期（唯一）
- `menu_content` - 菜单内容（文本）
- `evidence_photo_url` - 证据照片URL

**使用场景**：
- 特训工作台菜单录入
- 家长查看日报时显示菜单
- 从周食谱自动同步菜单

---

## 2. 商业分析地图 (Catering Business Analysis)

商业分析系统负责食材管理、菜品管理、食谱排期、成本分析等业务。

### 2.1 核心业务表

#### `ingredients` - 食材表
**用途**：存储食材基础信息，包括价格、来源、过敏类型等

**主要字段**：
- `id` - 主键
- `name` - 食材名称
- `category` - 分类（如：蔬菜、肉类、主食等）
- `unit` - 单位（如：kg、g、个等）
- `allergen_type` - 过敏类型（如：无、花生、牛奶等）
- `price` - 单价
- `source` - 采购来源（如：盒马鲜生、山姆、麦德龙等）

**使用场景**：
- 食材库管理
- 成本计算
- 过敏原检查
- 采购单生成

---

#### `dishes` - 菜品表
**用途**：存储菜品信息

**主要字段**：
- `id` - 主键
- `name` - 菜品名称
- `photo_url` - 照片URL
- `description` - 描述
- `tags` - 标签（数组，如：["清淡", "营养"]）

**使用场景**：
- 菜品库管理
- 食谱排期
- 家长端公开食谱展示

---

#### `dish_ingredients` - 菜品食材关联表
**用途**：记录每个菜品使用的食材及用量

**主要字段**：
- `dish_id` - 菜品ID（外键）
- `ingredient_id` - 食材ID（外键）
- `quantity` - 用量（基于10人基准）

**使用场景**：
- 菜品成本计算
- 采购单生成
- 过敏原检查

**业务逻辑**：
- `quantity` 基于10人基准，实际采购时按实际人数比例计算

---

#### `weekly_menus` - 周食谱表
**用途**：记录每日每餐的菜品安排

**主要字段**：
- `id` - 主键
- `plan_date` - 计划日期
- `meal_type` - 餐次类型（'lunch' 午餐 / 'dinner' 晚餐 / 'snack' 加餐）
- `dish_id` - 菜品ID（外键）

**唯一约束**：`(plan_date, meal_type, dish_id)`

**使用场景**：
- 食谱排期管理
- 采购单生成
- 成本分析
- 家长端公开食谱

---

### 2.2 统计查询表（复用）

#### `daily_reports` - 日报表（复用）
**用途**：用于统计每日实际用餐人数

**使用场景**：
- 成本分析时统计实际人数
- 计算人均成本

---

#### `students` - 学员表（复用）
**用途**：用于统计总人数作为兜底数据

**使用场景**：
- 成本分析时获取兜底人数
- 采购单生成时计算实际采购量

---

## 3. 家庭成长银行 (Family Points System)

家庭成长银行系统负责家庭成员管理、积分任务、奖励兑换、竞拍等业务。

### 3.1 核心业务表

#### `family_members` - 家庭成员表
**用途**：存储家庭成员信息

**主要字段**：
- `id` - 主键
- `parent_id` - 家长用户ID（外键 → users）
- `name` - 成员姓名
- `avatar` - 头像URL
- `created_at` - 创建时间

**使用场景**：
- 成员管理
- 积分面板切换成员
- 任务和奖励的可见性控制

---

#### `family_tasks` - 任务表
**用途**：存储赚分任务和扣分任务的定义

**主要字段**：
- `id` - 主键
- `parent_id` - 创建者用户ID（外键 → users，0 表示系统默认）
- `title` - 任务标题
- `category` - 分类（外键 → family_categories.key）
- `points` - 积分值（正数为赚分，负数为扣分）
- `icon` - 图标
- `target_members` - 目标成员ID数组（NULL 表示所有成员可见）

**使用场景**：
- 任务列表展示
- 完成任务记录积分
- 任务分类管理

---

#### `family_rewards` - 奖励/竞拍品表
**用途**：存储奖品和竞拍品信息

**主要字段**：
- `id` - 主键
- `parent_id` - 创建者用户ID（外键 → users，0 表示系统默认）
- `name` - 名称
- `cost` - 积分成本
- `type` - 类型（'reward' 奖品 / 'auction' 竞拍）
- `limit_type` - 限制类型（'unlimited' 不限 / 'weekly' 每周 / 'monthly' 每月）
- `limit_max` - 周期内最大兑换次数
- `target_members` - 目标成员ID数组（NULL 表示所有成员可见）
- `description` - 描述（竞拍品专用，富文本）
- `created_at` - 创建时间

**使用场景**：
- 奖品列表展示
- 兑换奖品
- 竞拍结算
- 限制次数检查

---

#### `family_points_log` - 积分流水表
**用途**：记录所有积分变动（赚分、扣分、兑换、竞拍）

**主要字段**：
- `id` - 主键
- `member_id` - 成员ID（外键 → family_members）
- `task_id` - 任务ID（外键 → family_tasks，可选）
- `reward_id` - 奖励ID（外键 → family_rewards，可选）
- `description` - 描述
- `points_change` - 积分变动（正数为赚分，负数为扣分/兑换）
- `created_at` - 创建时间

**使用场景**：
- 积分历史查询
- 账单日历展示
- 限制次数统计
- 撤销操作

**业务逻辑**：
- 积分余额 = `SUM(points_change)` 按成员分组
- 限制次数统计：按周期（weekly/monthly）和 `reward_id` 分组统计

---

### 3.2 辅助表

#### `family_categories` - 分类表
**用途**：存储任务分类信息

**主要字段**：
- `id` - 主键
- `parent_id` - 创建者用户ID（外键 → users，0 表示系统默认）
- `name` - 分类名称
- `key` - 分类键值（唯一标识）
- `sort_order` - 排序顺序

**使用场景**：
- 任务分类管理
- 任务列表按分类展示

---

## 表关系总结

### 4.1 共享表

以下表被多个子系统共同使用：

| 表名 | 使用系统 | 用途 |
|------|---------|------|
| `students` | 教务系统、商业分析 | 学员信息、人数统计 |
| `daily_reports` | 教务系统、商业分析 | 日报数据、人数统计 |
| `users` | 教务系统、家庭系统 | 用户认证、权限控制 |

### 4.2 系统独立性

#### 教务系统独立表
- `classes` - 课程表
- `student_course_balance` - 课程余额表
- `attendance` - 签到表
- `orders` - 订单表
- `daily_menus` - 每日菜单表

#### 商业分析系统独立表
- `ingredients` - 食材表
- `dishes` - 菜品表
- `dish_ingredients` - 菜品食材关联表
- `weekly_menus` - 周食谱表

#### 家庭系统独立表（使用 `family_` 前缀）
- `family_members` - 家庭成员表
- `family_tasks` - 任务表
- `family_rewards` - 奖励表
- `family_points_log` - 积分流水表
- `family_categories` - 分类表

### 4.3 表关系图

```
教务系统核心关系：
students ←── student_course_balance ──→ classes
   ↓                    ↓                    ↓
attendance          orders              daily_reports
   ↓                    ↓                    ↓
  users            daily_menus          (商业分析复用)

商业分析核心关系：
ingredients ←── dish_ingredients ──→ dishes
                                    ↓
                              weekly_menus
                                    ↓
                            (成本分析统计)

家庭系统核心关系：
users ←── family_members ←── family_points_log
                              ↓           ↓
                        family_tasks  family_rewards
                              ↓           ↓
                    family_categories
```

---

## 5. 数据库设计原则

### 5.1 命名规范
- 表名使用小写字母和下划线
- 家庭系统表使用 `family_` 前缀
- 外键字段使用 `表名_id` 格式（如 `student_id`）

### 5.2 软删除策略
- `students` 表使用 `status` 字段（'active' / 'inactive'）实现软删除
- `classes` 表使用 `is_active` 字段实现停用
- 保留历史数据，便于数据分析和审计

### 5.3 财务一致性
- 使用数据库事务（Transaction）保证资金操作的原子性
- 退费使用负数订单，保证 `SUM(amount)` 统计准确
- 积分系统使用 `points_change` 字段，余额通过聚合计算

### 5.4 时间字段
- 统一使用 `created_at` / `updated_at` 记录创建和更新时间
- 使用 `expired_at` 记录有效期
- 使用 `report_date` / `plan_date` 记录业务日期

---

## 6. 索引建议

### 6.1 高频查询字段
- `students.status` - 学员状态筛选
- `student_course_balance(student_id, class_id)` - 复合唯一索引
- `attendance(student_id, class_id, sign_in_time)` - 签到查询
- `family_points_log(member_id, created_at)` - 积分历史查询
- `weekly_menus(plan_date)` - 食谱日期查询

### 6.2 外键索引
- 所有外键字段建议建立索引
- 如：`student_id`, `class_id`, `member_id`, `reward_id` 等

---

## 7. 数据统计查询示例

### 7.1 学员课程余额查询（CTE + JSON聚合）
```sql
WITH course_data AS (
  SELECT 
    scb.student_id,
    c.id as class_id,
    c.class_name, 
    scb.remaining_lessons,
    scb.expired_at
  FROM student_course_balance scb
  JOIN classes c ON scb.class_id = c.id
  WHERE scb.expired_at >= CURRENT_DATE
)
SELECT 
  s.*,
  json_agg(cd.*) as courses
FROM students s
LEFT JOIN course_data cd ON s.id = cd.student_id
WHERE s.status = 'active'
GROUP BY s.id;
```

### 7.2 成本分析查询（多表关联 + 分组统计）
```sql
SELECT 
  to_char(wm.plan_date, 'YYYY-MM-DD') as date,
  i.category,
  SUM(di.quantity * i.price) as benchmark_cost_10
FROM weekly_menus wm
JOIN dish_ingredients di ON wm.dish_id = di.dish_id
JOIN ingredients i ON di.ingredient_id = i.id
WHERE wm.plan_date >= $1 AND wm.plan_date <= $2
GROUP BY date, i.category;
```

### 7.3 积分限制次数统计（周期查询）
```sql
SELECT COUNT(*) 
FROM family_points_log 
WHERE member_id=$1 
  AND reward_id=$2 
  AND created_at >= $3  -- 周期开始时间
```

---

## 8. 注意事项

### 8.1 数据一致性
- 删除学员前检查 `student_course_balance` 是否有有效余额
- 删除课程前检查是否有在读学员和历史记录
- 删除食材前检查是否被菜品使用

### 8.2 性能优化
- 使用 CTE 和 JSON 聚合避免 N+1 查询问题
- 大数据量查询时使用分页
- 定期清理过期数据或归档历史数据

### 8.3 业务逻辑
- 签到前检查课程有效期和重复签到
- 兑换前检查积分余额和限制次数
- 退费时生成负数订单并清零课程余额

---

**文档版本**：v1.0  
**最后更新**：2026-01-03  
**维护者**：开发团队

