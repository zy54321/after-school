# 日报功能优化实施计划

## 📋 项目概述

基于现有日报系统，增加三个核心功能：
1. **个性化评语自动生成** - 基于数据自动生成自然、个性化的评语
2. **关联分析** - 自动分析数据之间的关联关系
3. **预警机制** - 自动检测异常情况并预警

---

## 🎯 功能1：个性化评语自动生成

### 步骤 1.1：创建评语生成工具函数
**文件**：`server/src/systems/education/utils/commentGenerator.js`（新建）

**内容**：
- 创建 `generateComment()` 函数
- 建立模板库（50-100个模板）
- 建立同义词库
- 实现多策略组合生成逻辑

**输入参数**：
- `studentData`: 当前数据（focus_minutes, homework_rating, distraction_count等）
- `historyData`: 最近7天历史数据
- `studentId`: 学员ID（用于随机种子）

**输出**：
- 个性化评语字符串

**工作量**：2-3小时

---

### 步骤 1.2：修改保存日报接口
**文件**：`server/src/systems/education/controllers/dailyReportController.js`

**修改位置**：`saveDailyWorkflow` 函数

**修改内容**：
- 在保存每个学员日报时，调用 `generateComment()` 生成评语
- 如果前端传入了 `teacher_comment`，优先使用（允许老师手动修改）
- 如果没有传入，则自动生成并保存

**SQL修改**：
- 确保 `teacher_comment` 字段被正确保存

**工作量**：30分钟

---

### 步骤 1.3：修改查看日报接口
**文件**：`server/src/systems/education/controllers/dailyReportController.js`

**修改位置**：`getStudentReportByToken` 函数

**修改内容**：
- 如果 `teacher_comment` 为空，自动生成评语
- 确保返回的评语是最新的

**工作量**：20分钟

---

### 步骤 1.4：前端展示优化（可选）
**文件**：`client/src/systems/education/views/ReportView.vue`

**修改内容**：
- 优化评语展示样式
- 如果评语是自动生成的，可以添加小标识（可选）

**工作量**：20分钟

---

## 📊 功能2：关联分析

### 步骤 2.1：创建关联分析工具函数
**文件**：`server/src/systems/education/utils/correlationAnalyzer.js`（新建）

**内容**：
- 创建 `analyzeCorrelations()` 函数
- 实现三个关联分析：
  1. 专注时长与作业质量的关系
  2. 用餐情况与专注度的关系
  3. 走神次数与作业质量的关系

**输入参数**：
- `studentId`: 学员ID
- `startDate`: 开始日期
- `endDate`: 结束日期（默认最近7天）

**输出**：
- 关联分析结果对象

**工作量**：2-3小时

---

### 步骤 2.2：修改查看日报接口
**文件**：`server/src/systems/education/controllers/dailyReportController.js`

**修改位置**：`getStudentReportByToken` 函数

**修改内容**：
- 调用 `analyzeCorrelations()` 获取关联分析数据
- 将分析结果添加到返回数据中

**返回数据结构**：
```javascript
{
  correlations: {
    focus_homework: {
      description: "专注时长与作业质量的关系",
      data: [...],
      insight: "专注时长≥200分钟时，作业评级A的比例为85%"
    },
    meal_focus: {...},
    distraction_homework: {...}
  }
}
```

**工作量**：30分钟

---

### 步骤 2.3：前端展示关联分析
**文件**：`client/src/systems/education/views/ReportView.vue`

**修改内容**：
- 添加"数据分析"模块（可选显示）
- 使用 ECharts 展示关联分析图表
- 显示分析洞察文字

**工作量**：1-2小时

---

## ⚠️ 功能3：预警机制

### 步骤 3.1：创建预警检测工具函数
**文件**：`server/src/systems/education/utils/alertGenerator.js`（新建）

**内容**：
- 创建 `generateAlerts()` 函数
- 实现四个预警规则：
  1. 专注力下降预警
  2. 作业质量预警
  3. 走神频率预警
  4. 行为习惯预警

**输入参数**：
- `studentId`: 学员ID
- `currentData`: 当前数据
- `historyData`: 最近7天历史数据

**输出**：
- 预警数组，每个预警包含：类型、级别、描述、建议

**工作量**：2-3小时

---

### 步骤 3.2：修改查看日报接口
**文件**：`server/src/systems/education/controllers/dailyReportController.js`

**修改位置**：`getStudentReportByToken` 函数

**修改内容**：
- 调用 `generateAlerts()` 获取预警信息
- 将预警信息添加到返回数据中

**返回数据结构**：
```javascript
{
  alerts: [
    {
      type: 'focus_decline',
      level: 'medium', // 'light' / 'medium' / 'severe'
      title: '专注力下降提醒',
      description: '连续3天专注时长下降',
      suggestion: '建议设定小目标，逐步提升专注力'
    }
  ]
}
```

**工作量**：30分钟

---

### 步骤 3.3：前端展示预警信息
**文件**：`client/src/systems/education/views/ReportView.vue`

**修改内容**：
- 在日报顶部添加"今日提醒"卡片（如果有预警）
- 根据预警级别显示不同颜色（蓝色/黄色/红色）
- 显示预警描述和建议

**工作量**：1小时

---

### 步骤 3.4：管理后台预警列表（可选）
**文件**：`server/src/systems/education/controllers/dailyReportController.js`（新增接口）
**文件**：`client/src/systems/education/views/DailyWorkflow.vue`（可选）

**内容**：
- 创建 `getTodayAlerts` 接口，返回今日所有学员的预警列表
- 在特训工作台页面显示预警列表（可选）

**工作量**：1-2小时（可选）

---

## 📁 文件清单

### 新建文件
1. `server/src/systems/education/utils/commentGenerator.js` - 评语生成器
2. `server/src/systems/education/utils/correlationAnalyzer.js` - 关联分析器
3. `server/src/systems/education/utils/alertGenerator.js` - 预警生成器

### 修改文件
1. `server/src/systems/education/controllers/dailyReportController.js` - 日报控制器
2. `client/src/systems/education/views/ReportView.vue` - 日报展示页面
3. `client/src/systems/education/views/DailyWorkflow.vue` - 特训工作台（可选）

---

## ⏱️ 时间估算

### 核心功能开发
- 功能1（个性化评语）：3-4小时
- 功能2（关联分析）：3-4小时
- 功能3（预警机制）：3-4小时

### 测试和优化
- 单元测试：1-2小时
- 集成测试：1-2小时
- 模板优化：1-2小时

**总计**：12-18小时

---

## 🔄 实施顺序

### 第一阶段：个性化评语（优先级最高）
1. 步骤 1.1：创建评语生成工具函数
2. 步骤 1.2：修改保存日报接口
3. 步骤 1.3：修改查看日报接口
4. 步骤 1.4：前端展示优化（可选）

### 第二阶段：预警机制（优先级高）
1. 步骤 3.1：创建预警检测工具函数
2. 步骤 3.2：修改查看日报接口
3. 步骤 3.3：前端展示预警信息
4. 步骤 3.4：管理后台预警列表（可选）

### 第三阶段：关联分析（优先级中）
1. 步骤 2.1：创建关联分析工具函数
2. 步骤 2.2：修改查看日报接口
3. 步骤 2.3：前端展示关联分析

---

## ✅ 验收标准

### 功能1：个性化评语
- [ ] 相同数据的学员生成不同的评语
- [ ] 评语自然流畅，不模板化
- [ ] 评语包含关键数据（专注时长、作业评级等）
- [ ] 评语长度适中（100-200字）
- [ ] 老师可以手动修改评语

### 功能2：关联分析
- [ ] 正确分析专注时长与作业质量的关系
- [ ] 正确分析用餐情况与专注度的关系
- [ ] 正确分析走神次数与作业质量的关系
- [ ] 分析结果以图表形式展示
- [ ] 提供分析洞察文字

### 功能3：预警机制
- [ ] 正确检测专注力下降（连续3天下降）
- [ ] 正确检测作业质量预警（连续2天C级）
- [ ] 正确检测走神频率预警（连续3天≥5次）
- [ ] 正确检测行为习惯预警（连续3天C级）
- [ ] 预警信息正确显示在日报中
- [ ] 预警级别正确（轻度/中度/重度）

---

## 🧪 测试计划

### 单元测试
- 测试评语生成函数（不同数据组合）
- 测试关联分析函数（不同历史数据）
- 测试预警检测函数（不同预警场景）

### 集成测试
- 测试保存日报时自动生成评语
- 测试查看日报时显示关联分析和预警
- 测试多个学员同时生成日报

### 用户测试
- 测试10-15个学员同时生成日报
- 验证评语的个性化程度
- 验证预警的准确性

---

## 📝 注意事项

1. **性能考虑**：
   - 评语生成和关联分析可能耗时，考虑异步处理或缓存
   - 预警检测可以批量处理，避免N+1查询

2. **数据安全**：
   - 确保历史数据查询有合理的日期范围限制
   - 确保预警信息仅对相关家长可见

3. **可扩展性**：
   - 模板库和规则可以配置化，便于后续调整
   - 预留接口，方便后续添加新的分析维度

4. **向后兼容**：
   - 确保现有功能不受影响
   - 新功能作为增强，不影响原有逻辑

---

## 🚀 开始执行确认

请确认以下内容：

1. ✅ 实施顺序是否合适？
2. ✅ 时间估算是否合理？
3. ✅ 验收标准是否明确？
4. ✅ 是否需要调整优先级？
5. ✅ 是否需要先实现某个功能的简化版本？

确认后，我将按照计划开始执行。

